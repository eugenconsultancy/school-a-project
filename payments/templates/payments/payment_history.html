{% extends 'accounts/base.html' %}

{% block content %}
<h2>My Payment History</h2>

{% if payments %}
<!-- Summary -->
<div style="background-color: #e8f5e9; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
        <div>
            <h3 style="margin-top: 0;">{{ student.user.get_full_name }}</h3>
            <p><strong>Admission Number:</strong> {{ student.admission_number }}</p>
            <p><strong>Total Payments Made:</strong> {{ payments.count }}</p>
        </div>
        <div style="text-align: right;">
            <p><strong>Total Amount Paid:</strong></p>
            <p style="font-size: 28px; font-weight: bold; color: #4CAF50;">
                Ksh {{ total_paid|default:"0.00"|floatformat:2 }}
            </p>
        </div>
    </div>
</div>

<!-- Payment List -->
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Term</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Method</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Reference</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for payment in payments %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.payment_date|date:"M d, Y" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.student_fee %}
                    {{ payment.student_fee.fee_structure.term }} {{ payment.student_fee.fee_structure.academic_year }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">
                Ksh {{ payment.amount|floatformat:2 }}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.get_payment_method_display }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <span style="
                    padding: 2px 8px;
                    border-radius: 3px;
                    color: white;
                    {% if payment.status == 'completed' %}background-color: #4CAF50;
                    {% elif payment.status == 'pending' %}background-color: #FF9800;
                    {% else %}background-color: #f44336;
                    {% endif %}
                ">
                    {{ payment.get_status_display }}
                </span>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.transaction_id %}
                    <small>{{ payment.transaction_id|truncatechars:15 }}</small>
                {% elif payment.receipt_number %}
                    {{ payment.receipt_number }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.status == 'completed' %}
                    <a href="#" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none;">Receipt</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Statistics -->
<div style="display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">By Payment Method</h4>
        <p><strong>M-Pesa:</strong> {{ mpesa_count|default:"0" }} payments</p>
        <p><strong>Cash:</strong> {{ cash_count|default:"0" }} payments</p>
        <p><strong>Bank:</strong> {{ bank_count|default:"0" }} payments</p>
    </div>
    
    <div style="background-color: #fff3e0; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Recent Activity</h4>
        <p><strong>Last Payment:</strong> {{ last_payment_date|date:"M d, Y"|default:"None" }}</p>
        <p><strong>Last Amount:</strong> Ksh {{ last_payment_amount|default:"0.00"|floatformat:2 }}</p>
    </div>
    
    <div style="background-color: #f3e5f5; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Summary</h4>
        <p><strong>Successful:</strong> {{ completed_count|default:"0" }}</p>
        <p><strong>Pending:</strong> {{ pending_count|default:"0" }}</p>
        <p><strong>Failed:</strong> {{ failed_count|default:"0" }}</p>
    </div>
</div>
{% else %}
<div style="background-color: #fff3e0; padding: 40px; text-align: center; border-radius: 5px;">
    <h3>No Payment History</h3>
    <p>You haven't made any payments yet.</p>
    {% if student %}
        <a href="{% url 'make_payment' %}" style="background-color: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; display: inline-block; margin-top: 20px;">
            Make Your First Payment
        </a>
    {% endif %}
</div>
{% endif %}

<div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 30px;">
    <h4>Need Help?</h4>
    <p>If you notice any discrepancies in your payment history:</p>
    <ul>
        <li>Check with the accounts office for clarification</li>
        <li>Keep all your payment receipts for reference</li>
        <li>Report any issues within 7 days of payment</li>
    </ul>
</div>
{% endblock %}