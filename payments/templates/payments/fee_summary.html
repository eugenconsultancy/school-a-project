{% extends 'accounts/base.html' %}

{% block content %}
<h2>Fee Summary</h2>

{% if user.is_admin %}
<div style="background-color: #e8f5e9; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
        <div>
            <h3 style="margin-top: 0;">School Financial Overview</h3>
            <p><strong>Total Students with Fees:</strong> {{ student_fees.count }}</p>
        </div>
        <div style="text-align: right;">
            <p><strong>Total Outstanding Balance:</strong></p>
            <p style="font-size: 24px; font-weight: bold; color: #f44336;">
                Ksh {{ total_balance|default:"0.00"|floatformat:2 }}
            </p>
        </div>
    </div>
</div>
{% elif user.is_teacher %}
<div style="background-color: #e3f2fd; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <h3 style="margin-top: 0;">My Classes Fee Summary</h3>
    <p><strong>Teacher:</strong> {{ user.get_full_name }}</p>
    <p><strong>Classes:</strong> {{ user.teacher_profile.classes }}</p>
</div>
{% elif user.is_student %}
<div style="background-color: #fff3e0; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
    <h3 style="margin-top: 0;">My Fee Summary</h3>
    <p><strong>Student:</strong> {{ user.get_full_name }}</p>
    <p>View your complete financial details in the Financial Dashboard</p>
</div>
{% endif %}

{% if student_fees %}
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            {% if user.is_admin or user.is_teacher %}
            <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Admission No</th>
            {% endif %}
            <th style="border: 1px solid #ddd; padding: 8px;">Fee Structure</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount Due</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount Paid</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Balance</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
            {% if user.is_admin %}
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for fee in student_fees %}
        <tr>
            {% if user.is_admin or user.is_teacher %}
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.student.user.get_full_name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.student.admission_number }}</td>
            {% endif %}
            <td style="border: 1px solid #ddd; padding: 8px;">{{ fee.fee_structure.name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ fee.amount_due|floatformat:2 }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ fee.amount_paid|floatformat:2 }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                {% if fee.balance > 0 %}
                    <span style="color: #f44336; font-weight: bold;">Ksh {{ fee.balance|floatformat:2 }}</span>
                {% else %}
                    <span style="color: #4CAF50;">Paid</span>
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if fee.is_paid %}
                    <span style="color: #4CAF50; font-weight: bold;">Paid</span>
                {% elif fee.balance > 0 %}
                    <span style="color: #FF9800;">Partial</span>
                {% else %}
                    <span style="color: #f44336;">Pending</span>
                {% endif %}
            </td>
            {% if user.is_admin %}
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="{% url 'record_payment' %}?student={{ fee.student.id }}" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none; margin-right: 5px;">Add Payment</a>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Summary Statistics -->
{% if user.is_admin or user.is_teacher %}
<div style="display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
    <div style="background-color: #ffebee; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Payment Status</h4>
        <p><strong>Fully Paid:</strong> {{ fully_paid_count|default:"0" }}</p>
        <p><strong>Partially Paid:</strong> {{ partially_paid_count|default:"0" }}</p>
        <p><strong>Not Paid:</strong> {{ not_paid_count|default:"0" }}</p>
    </div>
    
    <div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Financial Summary</h4>
        <p><strong>Total Due:</strong> Ksh {{ total_due|default:"0.00"|floatformat:2 }}</p>
        <p><strong>Total Paid:</strong> Ksh {{ total_paid|default:"0.00"|floatformat:2 }}</p>
        <p><strong>Collection Rate:</strong> {{ collection_rate|default:"0"|floatformat:1 }}%</p>
    </div>
    
    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Actions</h4>
        {% if user.is_admin %}
            <a href="{% url 'student_fee_list' %}" style="display: block; background-color: #4CAF50; color: white; padding: 10px; text-decoration: none; text-align: center; margin-bottom: 10px;">
                Manage Fees
            </a>
            <a href="{% url 'payment_list' %}" style="display: block; background-color: #2196F3; color: white; padding: 10px; text-decoration: none; text-align: center;">
                View Payments
            </a>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<div style="background-color: #f5f5f5; padding: 40px; text-align: center; border-radius: 5px;">
    <h3>No Fee Data Available</h3>
    <p>
        {% if user.is_admin %}
            No student fees have been assigned yet.
            <a href="{% url 'student_fee_list' %}" style="color: #2196F3;">Assign fees to students</a>
        {% elif user.is_teacher %}
            No students in your classes have fee assignments.
        {% else %}
            No fee information available for your account.
        {% endif %}
    </p>
</div>
{% endif %}

<div style="background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 30px;">
    <h4>Notes:</h4>
    <ul>
        {% if user.is_admin %}
            <li>This summary shows all student fee assignments</li>
            <li>Use the "Manage Fees" option for detailed fee management</li>
            <li>Collection rate = (Total Paid / Total Due) Ã— 100%</li>
        {% elif user.is_teacher %}
            <li>This summary shows fees for students in your classes only</li>
            <li>Contact the accounts office for detailed information</li>
        {% else %}
            <li>For detailed financial information, visit your Financial Dashboard</li>
            <li>Contact the accounts office for any fee-related queries</li>
        {% endif %}
    </ul>
</div>
{% endblock %}