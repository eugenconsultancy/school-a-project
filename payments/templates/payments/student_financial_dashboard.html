{% extends 'accounts/base.html' %}

{% block content %}
<h2>My Financial Dashboard</h2>

<div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
    <!-- Summary Cards -->
    <div style="flex: 1; min-width: 300px; background-color: #e8f5e9; padding: 20px; border-radius: 5px;">
        <h3>Financial Summary</h3>
        <p><strong>Total Amount Due:</strong> <span style="font-size: 24px; color: #f44336;">Ksh {{ total_due|floatformat:2 }}</span></p>
        <p><strong>Total Amount Paid:</strong> <span style="font-size: 24px; color: #4CAF50;">Ksh {{ total_paid|floatformat:2 }}</span></p>
        <p><strong>Current Balance:</strong> <span style="font-size: 24px; color: #FF9800;">Ksh {{ total_balance|floatformat:2 }}</span></p>
    </div>
    
    <!-- Quick Actions -->
    <div style="flex: 1; min-width: 300px; background-color: #e3f2fd; padding: 20px; border-radius: 5px;">
        <h3>Quick Actions</h3>
        {% if current_fee and current_fee.balance > 0 %}
            <a href="{% url 'make_payment' %}" style="display: block; background-color: #4CAF50; color: white; padding: 10px; text-decoration: none; text-align: center; margin-bottom: 10px;">
                Make Payment (Balance: Ksh {{ current_fee.balance|floatformat:2 }})
            </a>
        {% endif %}
        <a href="{% url 'payment_history' %}" style="display: block; background-color: #2196F3; color: white; padding: 10px; text-decoration: none; text-align: center;">
            View Payment History
        </a>
    </div>
</div>

<!-- Current Fee Details -->
{% if current_fee %}
<div style="background-color: #fff3e0; padding: 20px; border-radius: 5px; margin-top: 20px;">
    <h3>Current Term Fees</h3>
    <p><strong>Term:</strong> {{ current_fee.fee_structure.term }} {{ current_fee.fee_structure.academic_year }}</p>
    <p><strong>Due Date:</strong> {{ current_fee.due_date }}</p>
    
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Tuition Fee:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.fee_structure.tuition_fee|floatformat:2 }}</td>
        </tr>
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Boarding Fee:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.fee_structure.boarding_fee|floatformat:2 }}</td>
        </tr>
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Activity Fee:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.fee_structure.activity_fee|floatformat:2 }}</td>
        </tr>
        <tr style="background-color: #f9f9f9;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Subtotal:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.fee_structure.total_fee|floatformat:2 }}</td>
        </tr>
        {% if current_fee.additional_charges > 0 %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Additional Charges:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.additional_charges|floatformat:2 }}</td>
        </tr>
        {% endif %}
        {% if current_fee.penalty_charges > 0 %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Penalty Charges:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.penalty_charges|floatformat:2 }}</td>
        </tr>
        {% endif %}
        <tr style="background-color: #ffebee;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Total Amount Due:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">Ksh {{ current_fee.amount_due|floatformat:2 }}</td>
        </tr>
        <tr style="background-color: #e8f5e9;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Amount Paid:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ current_fee.amount_paid|floatformat:2 }}</td>
        </tr>
        <tr style="background-color: #fff3e0;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Balance:</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">
                {% if current_fee.balance > 0 %}
                    <span style="color: #f44336;">Ksh {{ current_fee.balance|floatformat:2 }}</span>
                {% else %}
                    <span style="color: #4CAF50;">PAID IN FULL</span>
                {% endif %}
            </td>
        </tr>
    </table>
</div>
{% endif %}

<!-- Additional Charges -->
{% if additional_charges %}
<div style="background-color: #ffebee; padding: 20px; border-radius: 5px; margin-top: 20px;">
    <h3>Pending Additional Charges</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px;">Charge Type</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Description</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Due Date</th>
            </tr>
        </thead>
        <tbody>
            {% for charge in additional_charges %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ charge.get_charge_type_display }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ charge.description }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ charge.amount|floatformat:2 }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ charge.due_date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Recent Payments -->
{% if recent_payments %}
<div style="background-color: #f9f9f9; padding: 20px; border-radius: 5px; margin-top: 20px;">
    <h3>Recent Payments (Last 30 Days)</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Method</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                <th style="border: 1px solid #ddd; padding: 8px;">Description</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in recent_payments %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.payment_date|date:"M d, Y" }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.get_payment_method_display }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">Ksh {{ payment.amount|floatformat:2 }}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    <span style="
                        padding: 2px 8px;
                        border-radius: 3px;
                        color: white;
                        {% if payment.status == 'completed' %}background-color: #4CAF50;
                        {% elif payment.status == 'pending' %}background-color: #FF9800;
                        {% else %}background-color: #f44336;
                        {% endif %}
                    ">
                        {{ payment.get_status_display }}
                    </span>
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.description|truncatechars:30 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-top: 20px;">
    <p><strong>Note:</strong> All payments should be made through approved channels. Keep your payment receipts for reference.</p>
    <p>For any discrepancies in your balance or additional charges, please contact the accounts office.</p>
</div>
{% endblock %}