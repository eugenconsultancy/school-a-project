{% extends 'accounts/base.html' %}

{% block content %}
<h2>All Payments</h2>

<!-- Filter Options -->
<div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <form method="get" style="display: flex; gap: 10px; align-items: center;">
        <div>
            <label for="status">Status:</label>
            <select name="status" id="status" style="padding: 5px;">
                <option value="">All</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
            </select>
        </div>
        <div>
            <label for="method">Method:</label>
            <select name="method" id="method" style="padding: 5px;">
                <option value="">All</option>
                <option value="mpesa">M-Pesa</option>
                <option value="cash">Cash</option>
                <option value="bank">Bank</option>
                <option value="cheque">Cheque</option>
            </select>
        </div>
        <button type="submit" style="background-color: #2196F3; color: white; padding: 5px 15px; border: none; cursor: pointer;">Filter</button>
        <a href="{% url 'payment_list' %}" style="background-color: #757575; color: white; padding: 5px 15px; text-decoration: none;">Clear</a>
    </form>
</div>

<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Student</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Method</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Transaction ID</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Confirmed By</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for payment in payments %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.payment_date|date:"M d, Y H:i" }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.student.user.get_full_name }}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">
                <strong>Ksh {{ payment.amount|floatformat:2 }}</strong>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ payment.get_payment_method_display }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <span style="
                    padding: 2px 8px;
                    border-radius: 3px;
                    color: white;
                    {% if payment.status == 'completed' %}background-color: #4CAF50;
                    {% elif payment.status == 'pending' %}background-color: #FF9800;
                    {% else %}background-color: #f44336;
                    {% endif %}
                ">
                    {{ payment.get_status_display }}
                </span>
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.transaction_id %}
                    <small>{{ payment.transaction_id|truncatechars:15 }}</small>
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                {% if payment.confirmed_by %}
                    {{ payment.confirmed_by.username }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <a href="#" style="background-color: #2196F3; color: white; padding: 5px 10px; text-decoration: none; margin-right: 5px;">View</a>
                {% if payment.status == 'pending' %}
                    <a href="#" style="background-color: #4CAF50; color: white; padding: 5px 10px; text-decoration: none;">Confirm</a>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="8" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No payments found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Summary Statistics -->
{% if payments %}
<div style="display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
    <div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Total Payments</h4>
        <p style="font-size: 18px; font-weight: bold;">
            Ksh {{ total_amount|default:"0.00"|floatformat:2 }}
        </p>
    </div>
    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Completed</h4>
        <p style="font-size: 18px; font-weight: bold;">
            {{ completed_count|default:"0" }} payments
        </p>
    </div>
    <div style="background-color: #fff3e0; padding: 15px; border-radius: 5px; flex: 1; min-width: 200px;">
        <h4 style="margin-top: 0;">Pending</h4>
        <p style="font-size: 18px; font-weight: bold;">
            {{ pending_count|default:"0" }} payments
        </p>
    </div>
</div>
{% endif %}
{% endblock %}